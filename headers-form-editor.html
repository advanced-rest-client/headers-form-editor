<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-input/paper-input-container.html">
<link rel="import" href="../paper-input/paper-input-error.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../arc-definitions/arc-definitions.html">
<link rel="import" href="../headers-parser-behavior/headers-parser-behavior.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../markdown-styles/markdown-styles.html">
<!--
A headers form to be used to render a form of HTTP headers.

### Example

```html
<headers-form-editor></headers-form-editor>
```

```javascript
var form = document.querySelector('raml-headers-form');
form.ramlHeaders = []; // Put headers property from the RAML JS parser.
form.addEventListener('value-changed', function(e) {
  var value = e.detail.value;
});
```

### The value

The value can be simply set by setting an HTTP headers string value to element's `value` property.
It transforms the value into internal data model that will build the form. If you need more advanced
solutions (adding validation, required items, setting data types) you can set data model manually
by setting an array to `headersModel` property.

### Data model

Data model items represent a form element in the headers form. Below is the list of properties
supported by the form.

You can call `createModel()` function on the element to create a model item with all
default properties from only properties you currently have.

Property | Type | Description | Default
----------------|-------------|----------
`required` | Boolean | If set then the item is required with the form. Make only sense when setting header name. It will also prohibit the header from being removed from the editor. | `false`
`type` | String | Header value input's type. Currently supported values are `number` and `text` | `text`
`example` | String | If set, it adds an example in the value input's placeholder. If item is required and `default` is not set it sets the value of the input from the example. | ``
`default` | String | If set and `required` is `true` then set's the value of the header to this property. Do nothing if value is already set. |
`name` | String | Name of the header | ``
`value` | String | Value of the header | ``
`description` | String | Markdown description of the header. If set it will add an icon button next to "remove" button to display an inline documentation below the input field. | ``
`enum` | `Array<String>` | The value can be one of predefined values. In this case it will display a dropdown with predefined values to choose from. | `undefined`

### Styling
`<headers-form-editor>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--headers-form-editor` | Mixin applied to the element | `{}`

@group UI Elements
@element headers-form-editor
@demo demo/index.html
-->
<dom-module id="headers-form-editor">
  <template strip-whitespace>
    <style include="markdown-styles"></style>
    <style>
     :host {
      display: block;
      @apply(--headers-form-editor);
      --paper-input-container-label: {
        color: var(--headers-form-editor-input-label-color, var(--raml-headers-form-input-label-color, rgba(0, 0, 0, 0.48)));
      }
    }

    .required paper-input {
      --paper-input-container-label: {
        color: var(--headers-form-editor-input-label-color-required, var(--raml-headers-form-required-input-label-color, rgba(0, 0, 0, 0.72)));
      }
    }

    .header-value {
      @apply(--raml-headers-form-row);
      position: relative;
    }

    .header-value .input {
      @apply(--layout-horizontal);
      @apply(--layout-flex);
    }

    :host([narrow]) .header-value .input {
      @apply(--layout-vertical);
      margin-bottom: 12px;
    }

    .docs {
      @apply(--arc-font-common-base);
      font-size: 13px !important;
      font-weight: 200;
      line-height: 24px;
      color: var(--inline-documentation-color, rgba(0, 0, 0, 0.87));
    }

    .markdown-html * {
      font-size: 13px !important;
    }

    .markdown-html p:first-child {
      margin-top: 0;
      padding-top: 0;
    }

    .markdown-html p:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .help-icon {
      color: var(--inline-help-icon-color, rgba(0, 0, 0, 0.24));
      transition: color 0.2s linear;
    }

    .help-icon:hover {
      color: var(--inline-help-icon-color-hover, var(--accent-color, rgba(0, 0, 0, 0.74)));
    }

    .value-input {
      @apply(--layout-horizontal);
      @apply(--layout-center);
      @apply(--layout-flex);
    }

    .value-input paper-dropdown-menu,
    .value-input paper-input {
      @apply(--layout-flex);
    }

    .header-name {
      margin-right: 8px;
    }

    .action-button {
      color: var(--headers-form-editor-action-button-color, var(--secondary-button-color, --accent-color));
      background: var(--headers-form-editor-action-button-background, var(--secondary-button-background, #fff));
      @apply(--secondary-button);
      @apply(--headers-form-editor-action-button);
    }

    .action-button:hover {
      color: var(--headers-form-editor-action-button-color-hover, var(--secondary-button-color, --accent-color));
      background: var(--headers-form-editor-action-button-background-hover, var(--secondary-button-background, #fff));
      @apply(--secondary-button-hover);
      @apply(--headers-form-editor-action-button-hover);
    }

    .add-action {
      margin-top: 8px;
    }
    </style>
    <form is="iron-form" id="form">
      <template is="dom-repeat" items="{{headersModel}}" id="headersList">
        <div class$="[[_computeRowClass(item)]]">
          <div class="value-input">
            <template is="dom-if" if="[[item.isEnum]]">
              <paper-dropdown-menu label="[[item.inputLabel]]" name="[[item.name]]" required$="[[item.required]]" id="rrpv-[[index]]">
                <paper-listbox class="dropdown-content" attr-for-selected="data-value" selected="{{item.value}}">
                  <template is="dom-repeat" items="[[item.enum]]">
                    <paper-item data-value="[[item]]">[[item]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
            </template>
            <template is="dom-if" if="[[!item.isEnum]]">
              <div class="input">
                <paper-input-container class="header-name" auto-validate>
                  <label>Header name</label>
                  <input is="iron-input" class="name-change-input" on-focus="_headerNameFocus" type="text" value="{{item.name::input}}" required pattern="\S*" on-input="_headerNameChanged" />
                  <paper-input-error>Header name is not valid</paper-input-error>
                </paper-input-container>
                <paper-input label="[[item.inputLabel]]" id="rrpv-[[index]]" value="{{item.value}}" required$="[[item.required]]" pattern="[[item.pattern]]" name="[[item.name]]" auto-validate type="[[item.inputType]]" min="[[item.minimum]]" max="[[item.maximum]]" maxlength="[[item.maxLength]]" always-float-label="[[item.inputFloatLabel]]" placeholder="[[item.inputPlaceholder]]"></paper-input>
              </div>
            </template>
            <template is="dom-if" if="[[!item.required]]">
              <paper-icon-button title="Remove header" class="delete-icon" suffix icon="arc:close" on-tap="_removeHeader"></paper-icon-button>
            </template>
            <template is="dom-if" if="[[item.description]]">
              <paper-icon-button title="Display documentation" class="help-icon" suffix icon="arc:help" on-tap="_openDocs"></paper-icon-button>
            </template>
          </div>
          <template is="dom-if" if="[[item.description]]">
            <div class="docs">
              <iron-collapse>
                <marked-element markdown="[[item.description]]">
                  <div class="markdown-html markdown-body"></div>
                </marked-element>
              </iron-collapse>
            </div>
          </template>
          <paper-autocomplete open-on-focus on-query="_queryHeaderName" on-selected="_onHeaderNameSelected"></paper-autocomplete>
        </div>
      </template>
    </form>
    <div class="add-action">
      <paper-button class="action-button" on-tap="add" hidden$="[[disallowCustom]]">Add header</paper-button>
    </div>
    <arc-definitions></arc-definitions>
  </template>
  <script>
  (function() {
    'use strict';
    /* jshint strict: true */
    Polymer({
      is: 'headers-form-editor',

      behaviors: [
        ArcBehaviors.HeadersParserBehavior,
        Polymer.IronValidatableBehavior
      ],

      /**
       * Fired when the headers value changed.
       *
       * @event request-headers-changed
       * @param {String} value The headers value.
       */

      properties: {
        /**
         * A model of the form elements.
         *
         * See element documentation for the data structure.
         */
        headersModel: Array,
        /**
         * It is currently focused input field for header name.
         * This field will receive autocomplete support.
         * @type {HTMLElement}
         */
        activeHeaderNameField: {
          type: HTMLElement,
          readOnly: true
        },
        /**
         * Active autocomplete element.
         *
         * @type {HTMLElement}
         */
        activeAutocompleteNameField: {
          type: HTMLElement,
          readOnly: true
        },
        // Current value of the headers. Changing the value will update the list of the headers.
        value: {
          type: String,
          value: '',
          notify: true
        },
        // If set, the form will be rendered in mobile friendly view.
        narrow: {
          type: Boolean,
          reflectToAttribute: true
        }
      },

      observers: [
        '_modelChanged(headersModel.*)',
        '_valueChanged(value)'
      ],

      listeners: {
        'iron-overlay-closed': '_autocompleteClosed'
      },

      // Computes class for the header item form container.
      _computeRowClass: function(item) {
        var clazz = 'header-value';
        if (item.required) {
          clazz += ' required';
        } else {
          clazz += ' optional';
        }
        return clazz;
      },

      // Overidden from Polymer.IronValidatableBehavior. Will set the `invalid`
      // attribute automatically, which should be used for styling.
      _getValidity: function() {
        return this.$.form.validate();
      },

      // Opens the documentation for item.
      _openDocs: function(e) {
        var index = this.$.headersList.indexForElement(e.target);
        var collapse = this.$.form.querySelector('.header-value:nth-child(' + (index + 1) +
          ') iron-collapse');
        if (!collapse) {
          return;
        }
        collapse.opened = !collapse.opened;
      },

      // Handler for the remove button click.
      _removeHeader: function(e) {
        var i = this.$.headersList.indexForElement(e.target);
        if (i < 0) {
          return;
        }
        this.splice('headersModel', i, 1);
      },
      /**
       * Appends a header to the list of headers.
       *
       * @param {Object} init An initial settings for the object. If any setting from the model is
       * not set a default value fill be used.
       */
      add: function(init) {
        if (init instanceof Event) {
          init = undefined;
        }
        init = init || {};
        var obj = this.createModel(init);
        if (!this.headersModel) {
          this.set('headersModel', [obj]);
        } else {
          this.push('headersModel', obj);
        }
      },
      /**
       * Creates an item model from an object with initial values.
       *
       * @param {object} item Map of any of allowed model properties.
       */
      createModel: function(item) {
        item = item || {};
        item.value = item.value || '';
        item.name = item.name || '';
        item.type = item.type || 'string';
        item.isEnum = !!(item.name && item.enum && item.enum.length);
        item.inputLabel = item.isEnum ? item.name : 'Header value';
        if (item.required) {
          item.inputLabel += '*';
        }
        if (['number', 'integer', 'float'].indexOf(item.type) !== -1) {
          item.inputType = 'number';
        } else {
          item.inputType = 'text';
        }

        if (item.example && typeof item.example === 'string') {
          item.inputPlaceholder = 'Example: ' + item.example;
        } else {
          item.inputPlaceholder = undefined;
        }

        if (item.inputPlaceholder) {
          item.inputFloatLabel = true;
        } else {
          item.inputFloatLabel = undefined;
        }

        if (item.required && typeof item.default !== 'undefined' && !item.value) {
          item.value = item.default;
        }

        if (typeof item.value === 'undefined' && item.required) {
          if (item.example) {
            item.value = item.example;
          }

          if (item.value && item.value.indexOf && item.value.indexOf(item.name + ':') === 0) {
            // in case if example contains a header name.
            item.value = item.value.substr(item.name.length + 1);
          }

          if (typeof item.value === 'undefined' && item.isEnum) {
            item.value = item.enum[0];
          }
        }
        return item;
      },

      // Handler for header name field focus
      _headerNameFocus: function(e) {
        var i = this.$.headersList.indexForElement(e.target);
        if (i === undefined || i < 0) {
          return;
        }
        var elm = Polymer.dom(this.root)
          .querySelector('.header-value:nth-child(' + (i + 1) + ') paper-autocomplete');
        if (!elm) {
          console.warn('Autocomplete element not found.');
          return;
        }
        elm.target = e.target;
        this._setActiveHeaderNameField(e.target);
        this._setActiveAutocompleteNameField(elm);
      },

      /**
       * A handler for the name change.
       * It updates the description and example of the header if the header name is known.
       */
      _headerNameChanged: function(e) {
        if (!e.model) {
          return;
        }
        var item = e.model.get('item');
        var index = this.$.headersList.indexForElement(e.target);
        if (!index && index !== 0) {
          return;
        }
        if (item.name) {
          if (this._queryHeaderInfo(item.name)) {
            return;
          }
        }
        this._updateCustomHeaderMeta(index);
      },

      /**
       * Queries for header description and examples.
       * If details for the header name are available then it will set the
       * corresponding item's example and description properties.
       *
       * @param {String} name Header name.
       * @return {Boolean} True if the example and description has been updated.
       */
      _queryHeaderInfo: function(name) {
        var info = this._queryHeaderNameSuggestions(name);
        var helpItem;
        var i;
        var len;
        if (info && info.length) {
          for (i = 0, len = info.length; i < len; i++) {
            if (info[i].key === name) {
              helpItem = info[i];
              break;
            }
          }
        }
        if (!helpItem) {
          return false;
        }
        // search for the source input.
        var headers = this.headersModel;
        var index;
        for (i = 0, len = headers.length; i < len; i++) {
          if (headers[i].name === name) {
            index = i;
            break;
          }
        }
        if (index === undefined) {
          return false;
        }
        this._updateCustomHeaderMeta(index, helpItem.desc, helpItem.example);
        return true;
      },
      /**
       * Updates headers metadata information after retrieving it from the `arc-definitions` element.
       *
       * @param {number} index Index of the item in `headersModel` array
       * @param {string} desc Description of the header
       * @param {string} example Example value of the header.
       */
      _updateCustomHeaderMeta: function(index, desc, example) {
        desc = desc || '';
        example = example || '';
        var item = Object.assign({}, this.headersModel[index]);
        item.description = desc;
        item.example = example;
        item = this.createModel(item);

        this.set(['headersModel', index, 'description'], item.description);
        this.set(['headersModel', index, 'example'], item.example);
        this.set(['headersModel', index, 'inputFloatLabel'], item.inputFloatLabel);
        this.set(['headersModel', index, 'inputPlaceholder'], item.inputPlaceholder);
      },

      /**
       * Handler for autosuggestion element.
       * It takes value from currently focused header name element (input) and query the datastore
       * for suggestions.
       *
       * @param {Event} e Autocomplete event
       */
      _queryHeaderName: function(e) {
        if (!this.activeAutocompleteNameField) {
          return;
        }
        var value = e.detail.value;
        if (!value) {
          var defs = this.$$('arc-definitions');
          if (defs && defs.requestHeaders) {
            this.activeAutocompleteNameField.source = defs.requestHeaders.map(function(item) {
              return item.key;
            });
          } else {
            this.activeAutocompleteNameField.source = [];
          }
          return;
        }
        var suggestions = this._queryHeaderNameSuggestions(value);
        if (!suggestions || !suggestions.length) {
          this.activeAutocompleteNameField.source = [];
          return;
        }
        this.activeAutocompleteNameField.source = suggestions.map(function(item) {
          return {
            value: item.key,
            display: item.key
          };
        });
      },
      /**
       * Queries the `arc-definition` element for a header.
       *
       * @param {string} q Name of the header.
       * @return {array} List of matched headers.
       */
      _queryHeaderNameSuggestions: function(q) {
        var event = this.fire('query-headers', {
          'type': 'request',
          'query': q
        });
        return event.detail.headers;
      },

      /**
       * A handler called when the user selects a suggestion.
       * @param {[type]} e [description]
       * @return {[type]}
       */
      _onHeaderNameSelected: function(e) {
        var index = this.$.headersList.indexForElement(this.activeHeaderNameField);
        if (index || index === 0) {
          this.set(['headersModel', index, 'name'], e.detail.value);
          var elm = Polymer.dom(this.root)
            .querySelector('.header-value:nth-child(' + (index + 1) + ') .name-change-input');
          if (elm) {
            elm.fire('bind-value-changed');
          }
          if (!this._queryHeaderInfo(e.detail.value)) {
            this._updateCustomHeaderMeta(index);
          }
        }
      },
      /**
       * Handler for the `value` property change.
       * This should be used only for internal change between the `value` and
       * the model.
       *
       * @param {String} value current value of the headers.
       */
      _valueChanged: function(value) {
        if (this._internalValueChange) {
          this.fire('request-headers-changed', {
            value: value
          });
          return;
        }

        var headers = this.headersToJSON(value);
        if (!headers || !headers.length) {
          this._internalValueChange = true;
          this.set('headersModel', []);
          this._internalValueChange = false;
          return;
        }

        var def = this.headersModel;
        var i;
        var len;
        var item;
        this._internalValueChange = true;
        if (def && def.length) {
          var defLength = def.length;
          for (i = 0, len = headers.length; i < len; i++) {
            var found = false;
            for (var j = 0; j < defLength; j++) {
              if (headers[i].name === def[j].name) {
                found = true;
                this.set(['headersModel', j, 'value'], headers[i].value);
                break;
              }
            }
            if (!found) {
              item = this._headersModelFromObject(headers[i]);
              this.push('headersModel', item);
              this._queryHeaderInfo(item.name);
            }
          }
          // remove headers that are currently in the form but they are not set in
          // the parsed values array.
          var parsedNames = headers.map(function(item) {
            return item.name;
          });
          for (i = def.length - 1; i >= 0; i--) {
            if (parsedNames.indexOf(def[i].name) === -1) {
              this.splice('headersModel', i, 1);
            }
          }
        } else {
          for (i = 0, len = headers.length; i < len; i++) {
            item = this._headersModelFromObject(headers[i]);
            this.push('headersModel', item);
            this._queryHeaderInfo(item.name);
          }
        }
        this._internalValueChange = false;
      },

      /**
       * Transforms generated from headers source string header object to
       * form's internal data object.
       *
       * @param {Object<string, string>} header Map of header properties (name
       * and value)
       * @return {Object} Internal data model created from the header.
       */
      _headersModelFromObject: function(header) {
        var obj = {
          name: header.name,
          value: header.value
        };
        return this.createModel(obj);
      },
      // Handler for the model change observer
      _modelChanged: function(record) {
        if (this._internalValueChange) {
          return;
        }
        if (record.path === 'headersModel') {
          // whole object has changed
          this._updateValue();
        } else if (record.path.match(/headersModel.#\d+.(name|value)/)) {
          this._updateValue();
        } else if (record.path === 'headersModel.splices') {
          this._updateValue();
        }
      },

      _updateValue: function() {
        var h = this.headersModel;
        if (!h || !h.length) {
          this.value = '';
          return;
        }
        var value = h.map(function(item) {
          var n = item.name || '';
          var v = item.value || '';
          if (!n && !v) {
            return;
          }
          return n + ': ' + v;
        }).filter(function(item) {
          return !!item;
        }).join('\n');
        this._internalValueChange = true;
        this.set('value', value);
        this._internalValueChange = false;
      },

      _autocompleteClosed: function() {
        this._setActiveHeaderNameField(undefined);
        this._setActiveAutocompleteNameField(undefined);
      }
    });
  })();
  </script>
</dom-module>
